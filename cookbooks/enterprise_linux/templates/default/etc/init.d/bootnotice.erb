#!/bin/bash
#
# bootnotice	Sends a notice that the server is starting up or shutting down.
#
# chkconfig: 2345 50 02

### BEGIN INIT INFO
# Provides:          bootnotice
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Sends boot notice notification
# Description:       Notifies slack that a server is powered on off or rebooted.
### END INIT INFO

<%= node['linux']['chef']['file_header'] %>

# Source function library.
. /etc/init.d/functions

INIT_STATE=${BASH_SOURCE[0]}
RUN_LEVEL=$(runlevel | awk '{print $2}')

### Slack Integration
SLACK_ENABLED="<%= node['linux']['slack_enabled'] %>"
SLACK_USER="<%= node['linux']['boot_notice_name'] %>"
SLACK_CHANNEL="<%= node['linux']['slack_channel'] %>"
SLACK_EMOJI="<%= node['linux']['boot_notice_emoji'] %>"
SLACK_API_PATH="<%= node['linux']['api_path'] %>"

function notify() {
  if [ ${SLACK_ENABLED} ]
  then
    curl -X POST --data-urlencode "payload={\"channel\": \"${SLACK_CHANNEL}\", \"username\": \"${SLACK_USER}\", \"text\": \"$1\", \"icon_emoji\": \"${SLACK_EMOJI}\"}" "https://hooks.slack.com/services/${SLACK_API_PATH}" >/var/log/notice 2>&1
  fi
}

case "$1" in
   *)
        if [ ${RUN_LEVEL} = 0 ]
        then
          notify "FYI.. I am shutting down."
        elif [ ${RUN_LEVEL} = 6 ]
        then
          notify "FYI.. I am rebooting"
        else
          if [ -e /var/lock/subsys/bootnotice ]
          then
            exit 0
          else
            if [ ${RUN_LEVEL} ]
            then
              notify "I am now online, currently at run level ${RUN_LEVEL}"
              touch /var/lock/subsys/bootnotice
            fi
          fi
        fi
        ;;
esac
exit 0
